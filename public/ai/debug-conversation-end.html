<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation End Flow - Debug Test</title>
    <style>
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #1a1f2e;
            color: #e0e0e0;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #0066cc;
            margin-bottom: 2rem;
        }
        
        .test-section {
            background: #232937;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 3px solid #0066cc;
        }
        
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #0052a3;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .status {
            background: #1a1f2e;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            color: #00cc88;
        }
        
        .error {
            color: #ff3b30;
        }
        
        .warning {
            color: #ff9500;
        }
        
        .info {
            color: #00a8cc;
        }
        
        pre {
            background: #0f1419;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
    </style>
</head>
<body>
    <h1>üîß Conversation End Flow - Debug Test Page</h1>
    
    <div class="test-section">
        <h2>1. Element Detection</h2>
        <p>Check if all required elements exist in the DOM:</p>
        <button onclick="checkElements()">Check Elements</button>
        <div id="elementStatus" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Individual Functions</h2>
        <div class="test-grid">
            <button onclick="testHideInput()">Test Hide Input</button>
            <button onclick="testShowEndContainer()">Test Show End Container</button>
            <button onclick="testShowModal()">Test Show Modal</button>
            <button onclick="testFullFlow()">Test Full Flow</button>
        </div>
        <div id="functionStatus" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Simulate Email Sent</h2>
        <p>Simulate the complete flow as if an email was just sent:</p>
        <button onclick="simulateEmailSent()">Simulate Email Sent</button>
        <div id="simulateStatus" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>4. DOM Inspector</h2>
        <button onclick="inspectDOM()">Inspect Current DOM State</button>
        <div id="domStatus" class="status"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Fix Attempts</h2>
        <button onclick="applyAllFixes()">Apply All Fixes</button>
        <button onclick="resetUI()">Reset UI</button>
        <div id="fixStatus" class="status"></div>
    </div>

    <script>
        // Logging helper
        function log(message, type = 'info') {
            const timestamp = new Date().toTimeString().split(' ')[0];
            const className = type;
            return `<div class="${className}">[${timestamp}] ${message}</div>`;
        }
        
        // 1. Check Elements
        function checkElements() {
            const status = document.getElementById('elementStatus');
            let html = '';
            
            const elements = [
                { selector: '.chat-input-container', name: 'Input Container' },
                { selector: '#chatInputContainer', name: 'Input Container (by ID)' },
                { selector: '.conversation-end-container', name: 'End Container' },
                { selector: '#conversationEndContainer', name: 'End Container (by ID)' },
                { selector: '.thank-you-modal', name: 'Thank You Modal' },
                { selector: '#thankYouModal', name: 'Thank You Modal (by ID)' },
                { selector: '.chat-messages', name: 'Chat Messages' },
                { selector: '.chat-input', name: 'Chat Input' },
                { selector: '.send-button', name: 'Send Button' }
            ];
            
            elements.forEach(el => {
                const found = document.querySelector(el.selector);
                if (found) {
                    html += log(`‚úÖ ${el.name}: FOUND`, 'success');
                    html += log(`   Display: ${window.getComputedStyle(found).display}`, 'info');
                    html += log(`   Visibility: ${window.getComputedStyle(found).visibility}`, 'info');
                } else {
                    html += log(`‚ùå ${el.name}: NOT FOUND`, 'error');
                }
            });
            
            status.innerHTML = html;
        }
        
        // 2. Test Hide Input
        function testHideInput() {
            const status = document.getElementById('functionStatus');
            let html = log('Testing: Hide Input Container', 'info');
            
            const input = document.querySelector('.chat-input-container') || 
                         document.querySelector('#chatInputContainer');
            
            if (input) {
                // Multiple hide methods
                input.style.display = 'none';
                input.style.visibility = 'hidden';
                input.style.opacity = '0';
                input.classList.add('hidden', 'email-sent');
                input.setAttribute('hidden', 'true');
                
                html += log('‚úÖ Applied multiple hide methods', 'success');
                html += log(`Final display: ${window.getComputedStyle(input).display}`, 'info');
            } else {
                html += log('‚ùå Input container not found', 'error');
            }
            
            status.innerHTML = html;
        }
        
        // 3. Test Show End Container
        function testShowEndContainer() {
            const status = document.getElementById('functionStatus');
            let html = log('Testing: Show End Container', 'info');
            
            let endContainer = document.querySelector('.conversation-end-container') || 
                              document.querySelector('#conversationEndContainer');
            
            if (!endContainer) {
                // Create if doesn't exist
                html += log('‚ö†Ô∏è End container not found, creating...', 'warning');
                endContainer = document.createElement('div');
                endContainer.className = 'conversation-end-container';
                endContainer.innerHTML = `
                    <p>Thanks for chatting!</p>
                    <button onclick="alert('Close clicked')">Close</button>
                `;
                
                const chatContainer = document.querySelector('.chat-container') || 
                                    document.querySelector('#chatContainer') ||
                                    document.body;
                chatContainer.appendChild(endContainer);
            }
            
            // Show it
            endContainer.style.display = 'flex';
            endContainer.style.visibility = 'visible';
            endContainer.style.opacity = '1';
            endContainer.classList.add('visible');
            endContainer.removeAttribute('hidden');
            
            html += log('‚úÖ End container shown', 'success');
            html += log(`Final display: ${window.getComputedStyle(endContainer).display}`, 'info');
            
            status.innerHTML = html;
        }
        
        // 4. Test Show Modal
        function testShowModal() {
            const status = document.getElementById('functionStatus');
            let html = log('Testing: Show Thank You Modal', 'info');
            
            let modal = document.querySelector('.thank-you-modal') || 
                       document.querySelector('#thankYouModal');
            
            if (!modal) {
                html += log('‚ö†Ô∏è Modal not found, creating...', 'warning');
                modal = document.createElement('div');
                modal.className = 'thank-you-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 999999;
                `;
                modal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 10px; color: black;">
                        <h2>Thank You!</h2>
                        <p>Test modal is working</p>
                        <button onclick="this.closest('.thank-you-modal').style.display='none'">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Show it
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            modal.classList.add('visible');
            
            html += log('‚úÖ Modal shown', 'success');
            html += log('Click anywhere on modal to close', 'info');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('functionStatus').innerHTML += log('Modal auto-hidden after 3s', 'info');
            }, 3000);
            
            status.innerHTML = html;
        }
        
        // 5. Test Full Flow
        function testFullFlow() {
            const status = document.getElementById('functionStatus');
            status.innerHTML = log('Starting full flow test...', 'info');
            
            // Step 1: Hide input
            setTimeout(() => {
                testHideInput();
                status.innerHTML += log('Step 1: Input hidden', 'success');
            }, 500);
            
            // Step 2: Show end container
            setTimeout(() => {
                testShowEndContainer();
                status.innerHTML += log('Step 2: End container shown', 'success');
            }, 1500);
            
            // Step 3: Show modal
            setTimeout(() => {
                testShowModal();
                status.innerHTML += log('Step 3: Modal shown', 'success');
                status.innerHTML += log('‚úÖ Full flow complete!', 'success');
            }, 2500);
        }
        
        // 6. Simulate Email Sent
        function simulateEmailSent() {
            const status = document.getElementById('simulateStatus');
            status.innerHTML = log('Simulating email sent event...', 'info');
            
            // Check if functions exist
            if (typeof handleConversationEnd === 'function') {
                handleConversationEnd();
                status.innerHTML += log('‚úÖ Called handleConversationEnd()', 'success');
            } else {
                status.innerHTML += log('‚ùå handleConversationEnd() not found', 'error');
                status.innerHTML += log('Applying manual fixes...', 'warning');
                applyAllFixes();
            }
            
            // Trigger custom event
            window.dispatchEvent(new Event('emailSent'));
            status.innerHTML += log('‚úÖ Dispatched emailSent event', 'success');
        }
        
        // 7. Inspect DOM
        function inspectDOM() {
            const status = document.getElementById('domStatus');
            let html = '<pre>';
            
            const elements = [
                '.chat-input-container',
                '.conversation-end-container',
                '.thank-you-modal'
            ];
            
            elements.forEach(selector => {
                const el = document.querySelector(selector);
                if (el) {
                    const styles = window.getComputedStyle(el);
                    html += `\n${selector}:\n`;
                    html += `  display: ${styles.display}\n`;
                    html += `  visibility: ${styles.visibility}\n`;
                    html += `  opacity: ${styles.opacity}\n`;
                    html += `  position: ${styles.position}\n`;
                    html += `  z-index: ${styles.zIndex}\n`;
                    html += `  classes: ${el.className}\n`;
                    html += `  hidden attr: ${el.hasAttribute('hidden')}\n`;
                } else {
                    html += `\n${selector}: NOT FOUND\n`;
                }
            });
            
            html += '</pre>';
            status.innerHTML = html;
        }
        
        // 8. Apply All Fixes
        function applyAllFixes() {
            const status = document.getElementById('fixStatus');
            let html = log('Applying all possible fixes...', 'info');
            
            // Fix 1: Force hide input
            const inputs = document.querySelectorAll('.chat-input-container, #chatInputContainer');
            inputs.forEach(input => {
                input.style.cssText = 'display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important;';
                input.remove(); // Nuclear option
            });
            html += log('‚úÖ Removed input containers', 'success');
            
            // Fix 2: Create and show end container
            let endContainer = document.querySelector('.conversation-end-container');
            if (!endContainer) {
                endContainer = document.createElement('div');
                endContainer.className = 'conversation-end-container';
                endContainer.style.cssText = 'display: flex; padding: 2rem; background: #232937; text-align: center;';
                endContainer.innerHTML = `
                    <p style="color: #e0e0e0; margin-bottom: 1rem;">Thanks for chatting with eXIQ!</p>
                    <button onclick="testShowModal()" style="background: #0066cc; color: white; border: none; padding: 1rem 2rem; border-radius: 25px; cursor: pointer;">Close eXIQ Agent</button>
                `;
                const parent = document.querySelector('.chat-container') || document.querySelector('#chatContainer') || document.body;
                parent.appendChild(endContainer);
            }
            endContainer.style.display = 'flex';
            html += log('‚úÖ End container created and shown', 'success');
            
            // Fix 3: Add body class
            document.body.classList.add('conversation-ended');
            html += log('‚úÖ Added body.conversation-ended class', 'success');
            
            status.innerHTML = html;
        }
        
        // 9. Reset UI
        function resetUI() {
            const status = document.getElementById('fixStatus');
            
            // Show input
            const inputs = document.querySelectorAll('.chat-input-container, #chatInputContainer');
            inputs.forEach(input => {
                input.style.display = '';
                input.style.visibility = '';
                input.style.position = '';
                input.style.opacity = '';
                input.classList.remove('hidden', 'email-sent', 'conversation-ended');
            });
            
            // Hide end container
            const endContainers = document.querySelectorAll('.conversation-end-container');
            endContainers.forEach(container => {
                container.style.display = 'none';
            });
            
            // Hide modal
            const modals = document.querySelectorAll('.thank-you-modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
                modal.classList.remove('visible', 'active');
            });
            
            // Remove body classes
            document.body.classList.remove('conversation-ended', 'modal-open');
            
            status.innerHTML = log('‚úÖ UI Reset Complete', 'success');
        }
        
        // Initial check on load
        window.addEventListener('load', () => {
            console.log('Debug page loaded. Run checkElements() to start.');
            checkElements();
        });
    </script>
</body>
</html>